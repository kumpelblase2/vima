<link rel="import" href="<%= asset_path('video-list.html') %>">

<template id="library-view">
  <video-list :videos="videos" :metadata="visibleMetadata" :selected="selected"></video-list>
</template>

<script>
    Vue.component('library-view', {
        template: document.currentScript.ownerDocument.querySelector("#library-view").innerHTML,
        props: {
            visibleMetadata: Array,
            selected: Array
        },
        data: function() {
            return {
                videos: [],
                loaded: false,
                lastQuery: null,
                currentlyEditing: null
            }
        },
        methods: {
            load: function() {
                this.loaded = false;
                $.ajax({
                    url: "/videos/list.json",
                    success: (response) => {
                        this.loaded = true;
                        this.videos = response;
                    }
                });
            },
            query: function(query) {
                this.loaded = false;
                $.ajax({
                    url: "/videos/search.json?query=" + encodeURIComponent(query),
                    success: (videos) => {
                        this.loaded = true;
                        this.videos = videos;
                    }
                });

                this.lastQuery = query;
            },
            refresh: function() {
                if(this.lastQuery && this.lastQuery.length() > 0) {
                    this.query(this.lastQuery);
                } else {
                    this.load();
                }
            },
            openEdit: function(video) {
                this.currentlyEditing = video;
            },
            closeEdit: function() {
                this.currentlyEditing = null;
            },
            clearSelected: function () {
                this.selected = [];
            }
        },
        events: {
            'video-update': function(video) {
                //TODO
            },
            'video-select': function(video) {
                this.selected.push(video);
            },
            'video-deselect': function(video) {
                const index = this.selected.findIndex((elem) => elem.id === video.id);
                if(index >= 0) {
                    this.selected.splice(index, index + 1);
                }
            }
        },
        ready: function() {
            this.load();
        }
    });
</script>